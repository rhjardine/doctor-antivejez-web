// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================================================
// ENUMS
// =================================================================
enum Role {
  ADMIN
  MEDICO
  COACH
  ADMINISTRATIVO
}

enum UserStatus {
  ACTIVO
  INACTIVO
}

enum Gender {
  MASCULINO
  FEMENINO
  MASCULINO_DEPORTIVO
  FEMENINO_DEPORTIVO
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum GuideItemType {
  STANDARD
  METABOLIC
  REVITALIZATION
}

enum MealType {
  DESAYUNO
  ALMUERZO
  CENA
  MERIENDAS_POSTRES
}

enum BloodTypeGroup {
  ALL
  O_B
  A_AB
}

enum FoodCategory {
  BENEFICIAL
  NEUTRAL
  AVOID
}

enum GeneralGuideType {
  AVOID
  SUBSTITUTE
}

enum DietType {
  NINO
  METABOLICA
  ANTIDIABETICA
  CITOSTATICA
  RENAL
}

enum BoardType {
  FORM_BIOPHYSICS
  FORM_BIOCHEMISTRY
}

enum ReportProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  ERROR
}

enum TestType {
  BIOFISICA
  BIOQUIMICA
  ORTOMOLECULAR
  GENETICA
}

enum LabReportType {
  TELOTEST
  NUTRIGEN
}

// ✅ ADICIÓN 1/3: Nuevo enum para el riesgo de NLR
enum NlrRiskLevel {
  OPTIMAL
  LOW_INFLAMMATION
  BORDERLINE
  MODERATE_INFLAMMATION
  HIGH_INFLAMMATION
  SEVERE_INFLAMMATION
  CRITICAL_INFLAMMATION
  EXTREME_RISK
}

// =================================================================
// Modelos de Autenticación y Usuarios (NextAuth.js)
// =================================================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(MEDICO)
  status        String     @default("ACTIVO")
  accounts      Account[]
  sessions      Session[]
  patients      Patient[]

  // Ledger Pattern: Créditos por tipo de test
  creditTransactions       CreditTransaction[]

  // Relaciones inversas: Tests realizados por este médico
  conductedBiophysicsTests     BiophysicsTest[]     @relation("DoctorBiophysics")
  conductedBiochemistryTests   BiochemistryTest[]   @relation("DoctorBiochemistry")
  conductedOrthomolecularTests OrthomolecularTest[] @relation("DoctorOrthomolecular")
  conductedGeneticTests        GeneticTest[]        @relation("DoctorGenetics")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =================================================================
// Modelo Ledger de Créditos (Libro Mayor)
// =================================================================
model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  testType    TestType
  amount      Int      // Positivo = recarga, Negativo = consumo
  description String?  // Ej. "Recarga Admin", "Test Biofísica consumido"
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, testType])
  @@map("credit_transactions")
}

// =================================================================
// Modelos de la Aplicación
// =================================================================
model Patient {
  id                  String               @id @default(cuid())
  controlNumber       Int                  @default(autoincrement())
  userId              String
  photo               String?
  nationality         String
  identification      String               @unique
  historyDate         DateTime
  lastName            String
  firstName           String
  birthDate           DateTime
  chronologicalAge    Int
  gender              Gender
  birthPlace          String
  phone               String
  maritalStatus       String
  profession          String
  country             String
  state               String
  city                String
  address             String
  bloodType           String
  email               String
  observations        String?
  shareDataConsent    Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  biophysicsTests     BiophysicsTest[]
  biochemistryTests   BiochemistryTest[]
  orthomolecularTests OrthomolecularTest[]
  geneticTests        GeneticTest[]
  appointments        Appointment[]
  guides              PatientGuide[]
  foodPlans           FoodPlan[]
  selectedDiets       DietType[]
  aiAnalyses          AIAnalysis[]

  // ✅ ADICIÓN 2/3: Nueva relación para los tests de NLR
  nlrTests            NlrTest[]
  omicTransactions    OmicTransaction[]
  labReports          LabReport[]

  @@map("patients")
}

// =================================================================
// Modelos de RI-Bio (Adherencia y Omics)
// =================================================================
enum OmicType {
  DETOX
  NUTRITION
  CELLULAR
  MINDSET
}

enum DataSource {
  MANUAL
  CLINIC
  WEARABLE
  AI_AGENT
}

model OmicTransaction {
  id              String   @id @default(cuid())
  patientId       String
  type            OmicType
  pointsEarned    Int
  pointsPotential Int      @default(100)
  
  // ✅ MEJORAS 2026:
  source          DataSource @default(MANUAL) // MANUAL o SYNC (wearables)
  metadata        Json?      // Para guardar detalles: { "stepCount": 10000, "fastingHours": 16 }
  notes           String?    // Comentario breve del paciente
  
  date            DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt // Crucial para auditoría médica

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
  @@map("omic_transactions")
}

model Appointment {
  id        String            @id @default(cuid())
  patientId String
  date      DateTime
  reason    String
  status    AppointmentStatus @default(SCHEDULED)
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

model BiophysicsTest {
  id                  String   @id @default(cuid())
  patientId           String
  chronologicalAge    Float
  biologicalAge       Float
  differentialAge     Float
  gender              String
  isAthlete           Boolean  @default(false)
  fatPercentage       Float?
  fatAge              Float?
  bmi                 Float?
  bmiAge              Float?
  digitalReflexes     Float?
  reflexesAge         Float?
  visualAccommodation Float?
  visualAge           Float?
  staticBalance       Float?
  balanceAge          Float?
  skinHydration       Float?
  hydrationAge        Float?
  systolicPressure    Float?
  systolicAge         Float?
  diastolicPressure   Float?
  diastolicAge        Float?
  recordedBy          String?  // ID del Profesional que realizó el test (legacy)
  doctorId            String?  // Médico que consumió el crédito
  testDate            DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User?   @relation("DoctorBiophysics", fields: [doctorId], references: [id])

  @@map("biophysics_tests")
}

model BiochemistryTest {
  id                  String   @id @default(cuid())
  patientId           String
  chronologicalAge    Float
  biochemicalAge      Float
  differentialAge     Float
  somatomedin         Float?
  somatomedinAge      Float?
  hba1c               Float?
  hba1cAge            Float?
  insulin             Float?
  insulinAge          Float?
  postPrandial        Float?
  postPrandialAge     Float?
  tgHdlRatio          Float?
  tgHdlRatioAge       Float?
  dhea                Float?
  dheaAge             Float?
  homocysteine        Float?
  homocysteineAge     Float?
  psa                 Float?
  psaAge              Float?
  fsh                 Float?
  fshAge              Float?
  boneDensitometry    Float?
  boneDensitometryAge Float?
  doctorId            String?  // Médico que consumió el crédito
  testDate            DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User?   @relation("DoctorBiochemistry", fields: [doctorId], references: [id])

  @@map("biochemistry_tests")
}

model OrthomolecularTest {
  id                String   @id @default(cuid())
  patientId         String
  chronologicalAge  Float
  orthomolecularAge Float
  differentialAge   Float
  doctorId          String?  // Médico que consumió el crédito
  testDate          DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  aluminio          Float?
  antimonio         Float?
  arsenico          Float?
  bario             Float?
  berilio           Float?
  bismuto           Float?
  cadmio            Float?
  mercurio          Float?
  niquel            Float?
  plata             Float?
  platino           Float?
  plomo             Float?
  talio             Float?
  tinio             Float?
  titanio           Float?
  torio             Float?
  uranio            Float?
  calcio            Float?
  calcioAlt         Float?
  magnesio          Float?
  magnesioAlt       Float?
  sodio             Float?
  potasio           Float?
  potasioAlt        Float?
  cobre             Float?
  cobreAlt          Float?
  zinc              Float?
  zincAlt           Float?
  manganeso         Float?
  manganesoAlt      Float?
  cromo             Float?
  cromoAlt          Float?
  vanadio           Float?
  molibdeno         Float?
  boro              Float?
  yodo              Float?
  litio             Float?
  phosphoro         Float?
  selenio           Float?
  estroncio         Float?
  azufre            Float?
  cobalto           Float?
  hierro            Float?
  germanio          Float?
  rubidio           Float?
  zirconio          Float?
  aluminioAge       Float?
  antimonioAge      Float?
  arsenicoAge       Float?
  barioAge          Float?
  berilioAge        Float?
  bismutoAge        Float?
  cadmioAge         Float?
  mercurioAge       Float?
  niquelAge         Float?
  plataAge          Float?
  platinoAge        Float?
  plomoAge          Float?
  talioAge          Float?
  tinioAge          Float?
  titanioAge        Float?
  torioAge          Float?
  uranioAge         Float?
  calcioAge         Float?
  calcioAltAge      Float?
  magnesioAge       Float?
  magnesioAltAge    Float?
  sodioAge          Float?
  potasioAge        Float?
  potasioAltAge     Float?
  cobreAge          Float?
  cobreAltAge       Float?
  zincAge           Float?
  zincAltAge        Float?
  manganesoAge      Float?
  manganesoAltAge   Float?
  cromoAge          Float?
  cromoAltAge       Float?
  vanadioAge        Float?
  molibdenoAge      Float?
  boroAge           Float?
  yodoAge           Float?
  litioAge          Float?
  phosphoroAge      Float?
  selenioAge        Float?
  estroncioAge      Float?
  azufreAge         Float?
  cobaltoAge        Float?
  hierroAge         Float?
  germanioAge       Float?
  rubidioAge        Float?
  zirconioAge       Float?

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User?   @relation("DoctorOrthomolecular", fields: [doctorId], references: [id])

  @@map("orthomolecular_tests")
}

// =================================================================
// Modelos para Baremos y Rangos
// =================================================================
model Range {
  id     Int     @id
  minAge Float
  maxAge Float
  boards Board[]

  @@map("ranges")
}

model Board {
  id        String    @id @default(cuid())
  rangeId   Int
  type      BoardType @default(FORM_BIOPHYSICS)
  name      String
  minValue  Float
  maxValue  Float
  inverse   Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  range Range @relation(fields: [rangeId], references: [id])

  @@map("boards")
}

// =================================================================
// Modelos para la Guía del Paciente
// =================================================================
model GuideCategory {
  id    String      @id @default(cuid())
  title String
  type  GuideItemType
  order Int         @default(0)
  items GuideItem[]

  @@map("guide_categories")
}

model GuideItem {
  id         String   @id @default(cuid())
  categoryId String
  name       String
  dose       String?
  isDefault  Boolean  @default(true)
  createdAt  DateTime @default(now())

  category GuideCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("guide_items")
}

model PatientGuide {
  id           String    @id @default(cuid())
  patientId    String
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  selections   Json
  observations String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("patient_guides")
}

// =================================================================
// Modelos para la Guía de Alimentación
// =================================================================
model FoodItem {
  id             String         @id @default(cuid())
  name           String
  mealType       MealType
  bloodTypeGroup BloodTypeGroup @default(ALL)
  category       FoodCategory   @default(BENEFICIAL)
  isDefault      Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  foodPlanId     String?
  foodPlan       FoodPlan?      @relation(fields: [foodPlanId], references: [id], onDelete: Cascade)

  @@map("food_items")
}

model FoodPlan {
  id           String   @id @default(cuid())
  patientId    String
  observations String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  patient Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  items   FoodItem[]

  @@map("food_plans")
}

model GeneralGuideItem {
  id        String           @id @default(cuid())
  text      String
  type      GeneralGuideType
  isDefault Boolean          @default(true)
  createdAt DateTime         @default(now())

  @@map("general_guide_items")
}

model WellnessKey {
  id          String   @id @default(cuid())
  title       String
  description String
  isDefault   Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("wellness_keys")
}

// =================================================================
// Modelos para el Agente de IA
// =================================================================
model AIAnalysis {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  analysisType     String // ej. "clinical_summary", "recommendation_generation"
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  responseTime     Float // en segundos
  prompt           String   @db.Text
  response         String   @db.Text
  modelUsed        String   // ej. "gemini-1.5-flash"
  
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@map("ai_analyses")
}

// ✅ ADICIÓN 3/3: Nuevo modelo para el test de NLR
model NlrTest {
  id           String       @id @default(cuid())
  patientId    String
  neutrophils  Float // Valor absoluto de neutrófilos
  lymphocytes  Float // Valor absoluto de linfocitos
  nlrValue     Float // El resultado del cálculo (neutrophils / lymphocytes)
  riskLevel    NlrRiskLevel
  recordedBy   String?      // ID del Profesional que realizó el test
  testDate     DateTime     @default(now())
  createdAt    DateTime     @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("nlr_tests")
}

model GeneticTest {
  id                    String   @id @default(cuid())
  patientId             String
  chronologicalAge      Float
  averageTelomereLength String
  biologicalAge         Float
  differentialAge       Float
  interpretation        String?  @db.Text
  therapeuticResults    Json?    // Array de objetos category/items
  recommendations       Json?    // Array de objetos category/points
  doctorId              String?  // Médico que consumió el crédito
  testDate              DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  User?   @relation("DoctorGenetics", fields: [doctorId], references: [id])

  @@map("genetic_tests")
}

model LabReport {
  id                String                 @id @default(cuid())
  patientId         String
  reportType        LabReportType          // TELOTEST or NUTRIGEN
  fileName          String                 // Original PDF filename
  fileUrl           String?                // Optional: stored PDF URL
  processingStatus  ReportProcessingStatus @default(PENDING)
  extractedData     Json?                  // Flexible JSON with summary field for PWA
  validatedData     Json?                  // Doctor-confirmed data
  isValidated       Boolean                @default(false)
  errorMessage      String?                @db.Text
  testDate          DateTime               @default(now())
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("lab_reports")
}

// =================================================================
// Modelos para el Historial de Campañas
// =================================================================
model Campaign {
  id            String    @id @default(cuid())
  name          String
  messageBody   String    @db.Text
  status        String
  channels      String[]
  totalContacts Int
  sentCount     Int       @default(0)
  failedCount   Int       @default(0)
  createdAt     DateTime  @default(now())

  messages      CampaignMessage[]

  @@map("campaigns")
}

model CampaignMessage {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId   String
  contactName String
  contactInfo String
  channel     String
  status      String
  providerId  String?
  error       String?  @db.Text
  sentAt      DateTime @default(now())

  @@map("campaign_messages")
}